
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>AirPlay Support &#8212; pyatv 0.4.0.dev0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API" href="api.html" />
    <link rel="prev" title="Retrieving metadata" href="metadata.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="airplay-support">
<span id="pyatv-airplay"></span><h1>AirPlay Support<a class="headerlink" href="#airplay-support" title="Permalink to this headline">¶</a></h1>
<p>Currently there is some AirPlay functionality supported in pyatv, but it is
very limited. Only two features are supported:</p>
<ul class="simple">
<li><p>Device authentication</p></li>
<li><p>Playing media via URL</p></li>
</ul>
<p>Additional features will be added as needed.</p>
<div class="section" id="device-authentication">
<h2>Device Authentication<a class="headerlink" href="#device-authentication" title="Permalink to this headline">¶</a></h2>
<p>In tvOS 10.2, Apple started to enforce a feature called “device authentication”.
This requires every device that streams content via AirPlay to enter a PIN code
the first time before playback is started. Once done, the user will never have
to do this again. The actual feature has been available for a while but as
opt-in, so it would have to be explicitly enabled. Now it is enabled by default
and cannot be disabled. Devices not running tvOS (e.g. Apple TV 2nd and 3rd
generation) are not affected, even though device authentication can be enabled
on theses devices as well.</p>
<p>The device authentication process is based on the <em>Secure Remote Password</em>
protocol (SRP), with slight modifications. All the reverse engineering required
for this process was made by funtax (GitHub username) and has merly been ported
to python for usage in this library. Please see references at bottom of page
for reference implementation.</p>
<div class="section" id="generating-credentials">
<h3>Generating credentials<a class="headerlink" href="#generating-credentials" title="Permalink to this headline">¶</a></h3>
<p>When performing device authentication, a device identifier and a private key is
required. Once authenticated, they can be used to authenticate without using a
PIN code. So they must be saved and re-used whenever something is to be played.</p>
<p>In this library, the device identifier and private key is called
<em>AirPlay credentials</em> and are concatenated into a string, using : as separator.
An example might look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">D9B75D737BE2F0F1</span><span class="p">:</span><span class="mi">6</span><span class="n">A26D8EB6F4AE2408757D5CA5FF9C37E96BEBB22C632426C4A02AD4FA895A85B</span>
       <span class="o">^</span>                       <span class="o">^</span>
  <span class="n">Identifier</span>              <span class="n">Private</span> <span class="n">key</span>
</pre></div>
</div>
<p>New (random) credentials can be generated and loaded in the following way:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">credentials</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">generate_credentials</span><span class="p">()</span>
<span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">load_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
</pre></div>
</div>
<p>It is important to load the newly created credentials as they are not
automatically loaded when being generated. This is also how previously
authenticated credentials are re-used.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is no builtin support for storing credentials. It is up to the
application to handle this.</p>
</div>
<p>API Reference: <a class="reference internal" href="api.html#pyatv.interface.AirPlay.generate_credentials" title="pyatv.interface.AirPlay.generate_credentials"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyatv.interface.AirPlay.generate_credentials()</span></code></a>,
<a class="reference internal" href="api.html#pyatv.interface.AirPlay.load_credentials" title="pyatv.interface.AirPlay.load_credentials"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyatv.interface.AirPlay.load_credentials()</span></code></a></p>
</div>
<div class="section" id="authenticating-credentials">
<h3>Authenticating credentials<a class="headerlink" href="#authenticating-credentials" title="Permalink to this headline">¶</a></h3>
<p>Performing the authentication requires two steps. First, the process must be
initiated with the device so that a PIN code is displayed. Then it can be
completed by providing the PIN code back to the library:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">start_authentication</span><span class="p">()</span>
<span class="n">pin</span> <span class="o">=</span> <span class="o">...</span>  <span class="c1"># Get PIN from user</span>
<span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">finish_authentication</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
</pre></div>
</div>
<p>If the authentication process fails, a
<a class="reference internal" href="api.html#pyatv.exceptions.DeviceAuthenticationError" title="pyatv.exceptions.DeviceAuthenticationError"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyatv.exceptions.DeviceAuthenticationError</span></code></a> is raised.</p>
<p>API Reference: <a class="reference internal" href="api.html#pyatv.interface.AirPlay.start_authentication" title="pyatv.interface.AirPlay.start_authentication"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyatv.interface.AirPlay.start_authentication()</span></code></a>,
<a class="reference internal" href="api.html#pyatv.interface.AirPlay.finish_authentication" title="pyatv.interface.AirPlay.finish_authentication"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyatv.interface.AirPlay.finish_authentication()</span></code></a></p>
</div>
<div class="section" id="verifying-credentials">
<h3>Verifying credentials<a class="headerlink" href="#verifying-credentials" title="Permalink to this headline">¶</a></h3>
<p>To verify if the loaded credentials are authenticated, <code class="docutils literal notranslate"><span class="pre">verify_authenticated</span></code>
can be used:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">credentials</span> <span class="o">=</span> <span class="o">...</span>
<span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">load_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>
<span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">verify_authenticated</span><span class="p">()</span>
</pre></div>
</div>
<p>If the credentials are not properly authenticated, a
<a class="reference internal" href="api.html#pyatv.exceptions.DeviceAuthenticationError" title="pyatv.exceptions.DeviceAuthenticationError"><code class="xref py py-class docutils literal notranslate"><span class="pre">pyatv.exceptions.DeviceAuthenticationError</span></code></a> is raised.</p>
<p>API Reference: <a class="reference internal" href="api.html#pyatv.interface.AirPlay.verify_authenticated" title="pyatv.interface.AirPlay.verify_authenticated"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyatv.interface.AirPlay.verify_authenticated()</span></code></a></p>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>A complete code example of the authentication might look like this (it’s
available under <code class="docutils literal notranslate"><span class="pre">examples</span></code>):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">from</span> <span class="nn">pyatv</span> <span class="kn">import</span> <span class="p">(</span><span class="n">exceptions</span><span class="p">,</span> <span class="n">helpers</span><span class="p">)</span>


<span class="nd">@asyncio.coroutine</span>
<span class="k">def</span> <span class="nf">authenticate_with_device</span><span class="p">(</span><span class="n">atv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform device authentication and print credentials.&quot;&quot;&quot;</span>
    <span class="n">credentials</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">generate_credentials</span><span class="p">()</span>
    <span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">load_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">start_authentication</span><span class="p">()</span>
        <span class="n">pin</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s1">&#39;PIN Code: &#39;</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">finish_authentication</span><span class="p">(</span><span class="n">pin</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Credentials: {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">credentials</span><span class="p">))</span>

    <span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">DeviceAuthenticationError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;Failed to authenticate&#39;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>


<span class="n">helpers</span><span class="o">.</span><span class="n">auto_connect</span><span class="p">(</span><span class="n">authenticate_with_device</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="playing-media">
<h2>Playing media<a class="headerlink" href="#playing-media" title="Permalink to this headline">¶</a></h2>
<p>Playing a URL is as simple as passing the URL to <code class="docutils literal notranslate"><span class="pre">play_url</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://...&#39;</span>
<span class="k">yield from</span> <span class="n">atv</span><span class="o">.</span><span class="n">airplay</span><span class="o">.</span><span class="n">play_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</pre></div>
</div>
<p>If the device requires device authentication, valid credentials must be loaded
using <a class="reference internal" href="api.html#pyatv.interface.AirPlay.load_credentials" title="pyatv.interface.AirPlay.load_credentials"><code class="xref py py-meth docutils literal notranslate"><span class="pre">pyatv.interface.AirPlay.load_credentials()</span></code></a> first. Otherwise an
error message will be shown on the screen.</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/funtax/AirPlayAuth">https://github.com/funtax/AirPlayAuth</a>
<a class="reference external" href="https://nto.github.io/AirPlay.html">https://nto.github.io/AirPlay.html</a></p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">pyatv</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="protocol.html">Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="finding_devices.html">Finding Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="pairing.html">Pairing with a device</a></li>
<li class="toctree-l1"><a class="reference internal" href="connecting.html">Connecting</a></li>
<li class="toctree-l1"><a class="reference internal" href="controlling.html">Controlling a device</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Retrieving metadata</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">AirPlay Support</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#device-authentication">Device Authentication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#playing-media">Playing media</a></li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="atvremote.html">Reference application: atvremote</a></li>
<li class="toctree-l1"><a class="reference internal" href="developing.html">Developing pyatv</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="metadata.html" title="previous chapter">Retrieving metadata</a></li>
      <li>Next: <a href="api.html" title="next chapter">API</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Pierre Ståhl.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/airplay.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>